<%- layout("layouts/boilerplate") %>

<div class="container mt-4">

  <!-- ================= TAX SWITCH ================= -->
  <div class="d-flex justify-content-end align-items-center mb-3">
    <span class="me-2 fw-semibold">Display total price with tax</span>
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" id="taxToggle" />
    </div>
  </div>

  <!-- ================= AIRBNB STYLE SEARCH ================= -->
  <form method="GET" action="/listings" class="airbnb-search mb-4">
    <% if (category) { %>
      <input type="hidden" name="category" value="<%= category %>">
    <% } %>

    <div class="search-pill">
      <i class="fa-solid fa-magnifying-glass"></i>

      <input
        type="text"
        name="search"
        placeholder="Search destinations"
        value="<%= search || '' %>"
      />

      <button type="submit">Search</button>
    </div>
  </form>

  <!-- ================= ICON FILTER BAR ================= -->
  <div class="filters-wrapper mb-4">
    <div class="filters d-flex gap-4 overflow-auto">

      <% const filters = [
        { key: "", icon: "fa-earth-asia", label: "All" },
        { key: "trending", icon: "fa-fire", label: "Trending" },
        { key: "rooms", icon: "fa-bed", label: "Rooms" },
        { key: "iconic", icon: "fa-city", label: "Iconic" },
        { key: "mountains", icon: "fa-mountain", label: "Mountains" },
        { key: "castles", icon: "fa-chess-rook", label: "Castles" },
        { key: "pools", icon: "fa-person-swimming", label: "Pools" },
        { key: "camping", icon: "fa-campground", label: "Camping" },
        { key: "farms", icon: "fa-tractor", label: "Farms" },
        { key: "arctic", icon: "fa-snowflake", label: "Arctic" },
      ]; %>

      <% for (let f of filters) { %>
        <a
          href="<%= f.key ? `/listings?category=${f.key}` : '/listings' %>"
          class="filter-item text-center <%= category === f.key ? 'active-filter' : '' %>"
        >
          <div class="fs-4">
            <i class="fa-solid <%= f.icon %>"></i>
          </div>
          <small><%= f.label %></small>
        </a>
      <% } %>

    </div>
  </div>

  <!-- ================= NO RESULTS ================= -->
  <% if (allListings.length === 0) { %>
    <p class="text-muted text-center mt-4">
      No listings found.
    </p>
  <% } %>

  <!-- ================= LISTINGS ================= -->
  <div class="row">
    <% for (let listing of allListings) { %>
      <div class="col-md-4 mb-4">
        <div class="card h-100 shadow-sm">
          <img
            src="<%= listing.image?.url || '/default.jpg' %>"
            class="card-img-top"
            style="height: 20rem; object-fit: cover;"
          >

          <div class="card-body">
            <h5><%= listing.title %></h5>

            <p
              class="text-muted price"
              data-base-price="<%= listing.price %>"
            >
              ₹ <%= listing.price %> / night
            </p>

            <a href="/listings/<%= listing._id %>" class="btn btn-primary btn-sm">
              View
            </a>
          </div>
        </div>
      </div>
    <% } %>
  </div>

</div>

<!-- ================= TAX SCRIPT ================= -->
<script>
  const TAX_RATE = 0.18;
  const toggle = document.getElementById("taxToggle");
  const prices = document.querySelectorAll(".price");

  toggle.addEventListener("change", () => {
    prices.forEach(p => {
      const base = Number(p.dataset.basePrice);
      if (toggle.checked) {
        const total = Math.round(base + base * TAX_RATE);
        p.innerText = `₹ ${total} / night (incl. tax)`;
      } else {
        p.innerText = `₹ ${base} / night`;
      }
    });
  });
</script>
